# MiniOS тАУ Phase 2: Memory Management

Phase 2 ржП ржЖржорж░рж╛ MiniOS-ржХрзЗ рж╢рзЗржЦрж╛ржЗ **ржорзЗржорзЛрж░рж┐ ржХрзАржнрж╛ржмрзЗ ржмрзБржЭрждрзЗ, ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржПржмржВ ржирж┐рж░рж╛ржкржжрзЗ ржирж┐рзЯржирзНрждрзНрж░ржг ржХрж░рждрзЗ рж╣рзЯ**ред

ржПржЗ ржлрзЗржЬ рж╢рзЗрж╖ рж╣рж▓рзЗ MiniOS ржЖрж░ ржЕржирзНржзржнрж╛ржмрзЗ RAM ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирж╛ред
рж╕рзЗ ржЬрж╛ржирзЗ:
- ржХрзЛржерж╛ ржерзЗржХрзЗ ржорзЗржорзЛрж░рж┐ рж╢рзБрж░рзБ
- ржХрждржЯрж╛ ржмрзНржпржмрж╣рж╛рж░ рж╣рзЯрзЗржЫрзЗ
- ржХрждржЯрж╛ ржмрж╛ржХрж┐
- ржХржЦржи ржерж╛ржорждрзЗ рж╣ржмрзЗ

ржПржЗ ржлрзЗржЬржЯрж╛ржЗ `malloc`, backend memory usage ржПржмржВ performance-ржПрж░ ржорзВрж▓ ржнрж┐рждрзНрждрж┐ред

---

## Phase 2 ржПрж░ рж▓ржХрзНрж╖рзНржп

Phase 2 рж╢рзЗрж╖рзЗ MiniOS ржкрж╛рж░ржмрзЗ:

- Kernel ржХрзЛржерж╛рзЯ рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗ рждрж╛ ржЬрж╛ржирждрзЗ
- Free memory (heap) ржХрзЛржерж╛ ржерзЗржХрзЗ рж╢рзБрж░рзБ рждрж╛ ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рждрзЗ
- Safe ржУ aligned memory allocate ржХрж░рждрзЗ
- Out-of-memory рж╣рж▓рзЗ panic ржХрж░рждрзЗ
- ржирж┐ржЬрзЗрж░ memory usage report ржХрж░рждрзЗ

---

## ржзрж╛ржк рзз: Kernel ржХрзЛржерж╛рзЯ рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗ рж╕рзЗржЯрж╛ ржЬрж╛ржирж╛

### ржХрзЗржи ржжрж░ржХрж╛рж░?

Kernel ржирж┐ржЬрзЗржЗ RAM-ржПрж░ ржПржХржЯрж╛ ржЕржВрж╢ ржжржЦрж▓ ржХрж░рзЗ рж░рж╛ржЦрзЗред
ржПржЗ ржЕржВрж╢рзЗрж░ ржЙржкрж░ ржЖржмрж╛рж░ ржорзЗржорзЛрж░рж┐ рж▓рж┐ржЦрж▓рзЗ OS crash ржХрж░ржмрзЗред

рждрж╛ржЗ OS-ржПрж░ ржкрзНрж░ржержо ржХрж╛ржЬ:
> тАЬKernel рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗ ржарж┐ржХ ржХрзЛржерж╛рзЯ?тАЭ

---

### Linker ржжрж┐рзЯрзЗ kernel end ржЪрж┐рж╣рзНржи ржжрзЗржУрзЯрж╛

Kernel compile рж╣ржУрзЯрж╛рж░ рж╕ржорзЯ linker ржарж┐ржХ ржХрж░рзЗ ржХрзЛржи code ржХрзЛржерж╛рзЯ ржмрж╕ржмрзЗред
ржЖржорж░рж╛ linker-ржХрзЗ ржмрж▓рж┐ kernel рж╢рзЗрж╖рзЗ ржПржХржЯрж╛ ржЪрж┐рж╣рзНржи ржмрж╕рж╛рждрзЗред

#### `linker.ld` ржлрж╛ржЗрж▓рзЗ:
```ld
_kernel_end = .;
````

`.` ржорж╛ржирзЗ ржмрж░рзНрждржорж╛ржи memory address
ржорж╛ржирзЗ ржПржЦрж╛ржирзЗ kernel рж╢рзЗрж╖ред

---

### C ржХрзЛржб ржерзЗржХрзЗ ржмрзНржпржмрж╣рж╛рж░

```c
extern char _kernel_end;
```

ржПржЯрж╛ variable ржирж╛, рж╢рзБржзрзБ ржПржХржЯрж╛ address markerред

---

## ржзрж╛ржк рзи: Heap (Free Memory) рж╢рзБрж░рзБ ржХрж░рж╛

### ржзрж╛рж░ржгрж╛

Kernel рж╢рзЗрж╖ рж╣ржУрзЯрж╛рж░ ржкрж░ ржерзЗржХрзЗржЗ free memory рж╢рзБрж░рзБред

```
| Bootloader | Kernel | Heap (Free Memory) |
```

Heap рж╣рж▓рзЛ рж╕рзЗржЗ ржЬрж╛рзЯржЧрж╛ ржпрзЗржЦрж╛ржи ржерзЗржХрзЗ ржЖржорж░рж╛ dynamic memory ржжрзЗржмрзЛред

---

### Heap рж╕ржорзНржкрж░рзНржХрж┐ржд ржнрзНржпрж╛рж░рж┐рзЯрзЗржмрж▓

ржЖржорж░рж╛ рждрж┐ржиржЯрж╛ ржЬрж┐ржирж┐рж╕ рж░рж╛ржЦрж┐:

* `heap_start` тЖТ heap ржХрзЛржерж╛ ржерзЗржХрзЗ рж╢рзБрж░рзБ
* `heap_end` тЖТ heap ржХрзЛржерж╛рзЯ рж╢рзЗрж╖
* `free_memory_address` тЖТ ржкрж░рзЗрж░ free ржЬрж╛рзЯржЧрж╛

---

### `init_memory()` ржлрж╛ржВрж╢ржи

```c
heap_start = align_up((uint32_t)&_kernel_end);
free_memory_address = heap_start;
heap_end = heap_start + HEAP_SIZE;
```

ржПржЦржи MiniOS ржЬрж╛ржирзЗ:

> тАЬржЖржорж┐ ржХрзЛржерж╛ ржерзЗржХрзЗ ржорзЗржорзЛрж░рж┐ ржжрж┐рждрзЗ ржкрж╛рж░рж┐тАЭ

---

## ржзрж╛ржк рзй: Simple Memory Allocator (kmalloc)

### ржЖржорж░рж╛ ржХрзЛржи allocator ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрж┐?

**Bump Allocator**
(ржПржХ рж▓рж╛ржЗржирзЗ: рж╕рж╛ржоржирзЗ ржПржЧрж┐рзЯрзЗ ржпрж╛ржУрзЯрж╛ allocator)

---

### ржХрзАржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?

1. ржмрж░рзНрждржорж╛ржи free address ржжрзЗрзЯ
2. pointer рж╕рж╛ржоржирзЗ рж╕рж░рж┐рзЯрзЗ ржжрзЗрзЯ
3. ржкрзБрж░рзЛржирзЛ ржорзЗржорзЛрж░рж┐ ржЖрж░ ржлрзЗрж░ржд ржирзЗрзЯ ржирж╛ (ржПржЦржирзЛ)

---

### `kmalloc()` implementation

```c
void* kmalloc(uint32_t size) {
    uint32_t aligned_address = align_up(free_memory_address);
    free_memory_address = aligned_address + size;
    return (void*)aligned_address;
}
```

ржПржЯрж╛ржЗ future `malloc()` ржПрж░ ржмрзЗрж╕ред

---

## ржзрж╛ржк рзк: Memory Alignment

### Alignment ржорж╛ржирзЗ ржХрзА?

CPU memory ржкрзЬрждрзЗ ржкржЫржирзНржж ржХрж░рзЗ **ржирж┐рж░рзНржжрж┐рж╖рзНржЯ boundary ржерзЗржХрзЗ**ред

ржпрзЗржоржи:

* int тЖТ 4 byte boundary
* pointer тЖТ aligned address

Misaligned memory:

* slow
* ржХржЦржирзЛ crash (ARM, RISC-V)

---

### OS-ржПрж░ ржжрж╛рзЯрж┐рждрзНржм

Compiler ржзрж░рзЗ ржирзЗрзЯ:

> тАЬOS ржарж┐ржХржарж╛ржХ aligned memory ржжрж┐ржЪрзНржЫрзЗтАЭ

рждрж╛ржЗ alignment ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рж╛ OS-ржПрж░ ржХрж╛ржЬред

---

### Alignment helper

```c
#define ALIGNMENT 4

static uint32_t align_up(uint32_t addr) {
    if (addr % ALIGNMENT == 0)
        return addr;
    return addr + (ALIGNMENT - (addr % ALIGNMENT));
}
```

рж╕ржм allocation ржПржЗ alignment ржорзЗржирзЗ рж╣рзЯред

---

## ржзрж╛ржк рзл: Out-of-Memory (OOM) Safety

### рж╕ржорж╕рзНржпрж╛

Heap рж╕рзАржорж╛рж╣рзАржи ржирж╛ред
Memory рж╢рзЗрж╖ рж╣рж▓рзЗ ржпржжрж┐ ржерж╛ржорж╛ ржирж╛ рж╣рзЯ, kernel corrupt рж╣ржмрзЗред

---

### рж╕ржорж╛ржзрж╛ржи

* Heap-ржПрж░ ржПржХржЯрж╛ fixed size ржзрж░рж┐
* рж╕рзАржорж╛ ржЫрж╛рзЬрж╛рж▓рзЗ panic ржХрж░рж┐

---

### Heap size

```c
#define HEAP_SIZE (1024 * 1024) // 1 MB
```

---

### OOM check рж╕рж╣ kmalloc

```c
if (next_free > heap_end) {
    print("KERNEL PANIC: Out of memory!\n");
    while (1) { }
}
```

Crash > silent bug
ржПржЗржЯрж╛ржЗ real OS behaviorред

---

## ржзрж╛ржк рзм: Memory Usage Statistics

### ржХрзЗржи ржжрж░ржХрж╛рж░?

Real system ржирж┐ржЬрзЗрж░ ржЕржмрж╕рзНржерж╛ ржЬрж╛ржирж╛рзЯред
Invisible system debug ржХрж░рж╛ ржпрж╛рзЯ ржирж╛ред

---

### ржХрзА ржХрзА ржжрзЗржЦрж╛ржЗ?

* Heap start
* Heap end
* Used memory
* Free memory

---

### `print_memory_stats()`

```c
void print_memory_stats() {
    uint32_t used = free_memory_address - heap_start;
    uint32_t total = heap_end - heap_start;
    uint32_t free = total - used;

    print("Used: ");
    print_dec(used);
    print(" bytes\n");

    print("Free: ");
    print_dec(free);
    print(" bytes\n");
}
```

ржПржЯрж╛ backend-ржПрж░ memory metrics-ржПрж░ ржорждрзЛржЗред


# ржзрж╛ржк 7: Simple free()

Phase 2.7 ржП ржЖржорж░рж╛ MiniOS-ржП `free()` ржпрзЛржЧ ржХрж░рж┐ред
рждржмрзЗ ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ Linux ржмрж╛ glibc-ржПрж░ ржорждрзЛ ржЬржЯрж┐рж▓ allocator ржмрж╛ржирж╛ржЪрзНржЫрж┐ ржирж╛ред

ржЖржорж░рж╛ ржмрж╛ржирж╛ржЪрзНржЫрж┐:
> **ржПржХржЯрж╛ рж╕рж╣ржЬ, ржирж┐рж░рж╛ржкржж, рж╢рзЗржЦрж╛рж░ ржЙржкржпрзЛржЧрзА free()**

ржПржЗ ржзрж╛ржкржЯрж╛ ржмрзБржЭрж▓рзЗ `malloc/free` ржПрж░ ржнрж┐рждрж░рзЗрж░ рж▓ржЬрж┐ржХ ржЖрж░ ржнрзЯржВржХрж░ рж▓рж╛ржЧржмрзЗ ржирж╛ред

---

## Phase 2.7 ржПрж░ рж▓ржХрзНрж╖рзНржп

ржПржЗ ржзрж╛ржк рж╢рзЗрж╖рзЗ MiniOS ржкрж╛рж░ржмрзЗ:

- рж╢рзЗрж╖ allocation ржлрзЗрж░ржд ржжрж┐рждрзЗ
- Heap pointer ржкрж┐ржЫржирзЗ ржЖржирждрзЗ
- Memory usage рж╕ржарж┐ржХржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ ржХрж░рждрзЗ
- Allocation + free ржПржХрж╕рж╛ржерзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ

ржПржЯрж╛ Phase 3 ржмрж╛ advanced allocator-ржПрж░ ржнрж┐рждрзНрждрж┐ред

---

## ржЖржЧрзЗ ржПржХржЯрж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг рж╕рждрзНржп ЁЯза

ржЖржорж╛ржжрзЗрж░ ржмрж░рзНрждржорж╛ржи allocator рж╣рж▓рзЛ:

> **Bump Allocator**

ржПрж░ ржмрзИрж╢рж┐рж╖рзНржЯрзНржп:
- рж╕рж╛ржоржирзЗ ржПржЧрж┐рзЯрзЗ allocation
- ржкрзБрж░рзЛржирзЛ allocation ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ track ржХрж░рж╛ рж╣рзЯ ржирж╛

рждрж╛ржЗ:
тЭМ ржпрзЗржХрзЛржирзЛ allocation free ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛  
тЬЕ рж╢рзБржзрзБ **рж╕рж░рзНржмрж╢рзЗрж╖ allocation** free ржХрж░рж╛ ржпрж╛ржмрзЗ

ржПржЗ pattern ржХрзЗ ржмрж▓рзЗ:
> **Stack-style (LIFO) allocation**

---

## Mental model (ржЦрзБржм ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг)

Heap ржПржЦржи ржПржоржи:

```

heap_start тФАтФАтФАтФА A тФАтФАтФАтФА B тФАтФАтФАтФА C тФАтФАтФАтФА free
тЖС
free_memory_address

````

ржПржЦрж╛ржирзЗ:
- ржЖржЧрзЗ A allocate
- рждрж╛рж░ржкрж░ B
- рждрж╛рж░ржкрж░ C

ржЖржорж░рж╛ ржкрж╛рж░ржмрзЛ:
- C free ржХрж░рждрзЗ
- рждрж╛рж░ржкрж░ B
- рждрж╛рж░ржкрж░ A

ржХрж┐ржирзНрждрзБ:
- ржорж╛ржЭржЦрж╛ржирзЗрж░ B ржПржХрж╛ free ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛

---

## ржзрж╛ржк рзз: Last allocation size ржоржирзЗ рж░рж╛ржЦрж╛

Free ржХрж░рждрзЗ рж╣рж▓рзЗ ржЬрж╛ржирждрзЗ рж╣ржмрзЗ:
> тАЬрж╢рзЗрж╖ржмрж╛рж░ ржХрждржЯрж╛ memory ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрж┐рж▓?тАЭ

---

### memory.c рждрзЗ ржирждрзБржи variable

```c
static uint32_t last_alloc_size = 0;
````

ржПржЯрж╛ рж╢рзБржзрзБ **рж╢рзЗрж╖ allocation** ржПрж░ size рж░рж╛ржЦржмрзЗред

---

## ржзрж╛ржк рзи: kmalloc() ржПржХржЯрзБ ржЖржкржбрзЗржЯ ржХрж░рж╛

`kmalloc()` ржПржЦржи allocation size record ржХрж░ржмрзЗред

```c
void* kmalloc(uint32_t size) {
    uint32_t aligned_address = align_up(free_memory_address);
    uint32_t next_free = aligned_address + size;

    if (next_free > heap_end) {
        print("KERNEL PANIC: Out of memory!\n");
        while (1) { }
    }

    last_alloc_size = size;
    free_memory_address = next_free;

    return (void*)aligned_address;
}
```

ржПржЦржи allocator ржЬрж╛ржирзЗ:

> тАЬрж╢рзЗрж╖ allocation ржХржд ржмрзЬ ржЫрж┐рж▓тАЭ

---

## ржзрж╛ржк рзй: kfree() ржлрж╛ржВрж╢ржи ржмрж╛ржирж╛ржирзЛ

### memory.h ржП ржШрзЛрж╖ржгрж╛

```c
void kfree();
```

---

### memory.c рждрзЗ implementation

```c
void kfree() {
    if (last_alloc_size == 0) {
        return;
    }

    free_memory_address -= last_alloc_size;
    last_alloc_size = 0;
}
```

---

## ржПржЗ free() ржЖрж╕рж▓рзЗ ржХрзА ржХрж░ржЫрзЗ?

* Heap pointer ржкрж┐ржЫрж┐рзЯрзЗ ржжрж┐ржЪрзНржЫрзЗ
* рж╢рзЗрж╖ allocation ржмрж╛рждрж┐рж▓ ржХрж░ржЫрзЗ
* ржХрзЛржирзЛ fragmentation рждрзИрж░рж┐ ржХрж░ржЫрзЗ ржирж╛

ржПржЯрж╛ржЗ stack allocator-ржПрж░ ржорзВрж▓ рж╢ржХрзНрждрж┐ред

---

## ржзрж╛ржк рзк: Simple test

`kernel.c` ржП:

```c
print_memory_stats();

char* a = kmalloc(100);
char* b = kmalloc(200);

print("\nAfter allocation:\n");
print_memory_stats();

kfree();

print("\nAfter free:\n");
print_memory_stats();
```

---

## Expected output (ржзрж╛рж░ржгрж╛)

```
Used: 300 bytes
Free: 1048276 bytes

After free:
Used: 100 bytes
Free: 1048476 bytes
```

ржжрзЗржЦрж╛ ржпрж╛ржЪрзНржЫрзЗ:

* рж╢рзБржзрзБ рж╢рзЗрж╖ allocation (200 bytes) ржлрзЗрж░ржд ржЧрзЗржЫрзЗ

---

## ржХрзЗржи ржПржЗ free() ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг?

### 1я╕ПтГг рж╢рзЗржЦрж╛рж░ ржЬржирзНржп perfect

ржПржЗржЯрж╛ ржирж╛ ржмрзБржЭрж▓рзЗ full malloc/free ржмрзЛржЭрж╛ ржХржарж┐ржиред

---

### 2я╕ПтГг Backend analogy

ржПржЗ pattern ржмрзНржпржмрж╣рж╛рж░ рж╣рзЯ:

* request-scoped memory
* arena allocator
* temporary buffers

ржЕржирзЗржХ high-performance backend ржПржЗржЯрж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред

---

### 3я╕ПтГг Fragmentation ржирж╛ржЗ

ржорж╛ржЭржЦрж╛ржирзЗ ржЧрж░рзНржд рждрзИрж░рж┐ рж╣рзЯ ржирж╛ред
Memory clean ржерж╛ржХрзЗред

---

## ржПржЗ free() ржПрж░ рж╕рзАржорж╛ржмржжрзНржзрждрж╛

ржПржЗржЯрж╛ ржЬрж╛ржирж╛ ржЦрзБржм ржЬрж░рзБрж░рж┐:

тЭМ ржпрзЗржХрзЛржирзЛ pointer free ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛
тЭМ double free detect ржХрж░рзЗ ржирж╛
тЭМ fragmentation handle ржХрж░рзЗ ржирж╛

ржХрж┐ржирзНрждрзБ:

> Phase 2-ржПрж░ ржЬржирзНржп ржПржЯрж╛ ржПржХржжржо рж╕ржарж┐ржХ

---

## Phase 2 рж╕ржорзНржкрзВрж░рзНржг рж╣рж▓рзЛ ЁЯОЙ

Phase 2 рж╢рзЗрж╖рзЗ MiniOS:

* Heap ржЬрж╛ржирзЗ
* Aligned memory ржжрзЗрзЯ
* OOM handle ржХрж░рзЗ
* Memory stats ржжрзЗржЦрж╛рзЯ
* Simple free() ржкрж╛рж░рзЗ

ржПржЗржЯрж╛ ржПржЦржи ржЖрж░ toy OS ржирж╛ред
ржПржЯрж╛ ржПржХржЯрж╛ **рж╢рж┐ржХрзНрж╖ржгржпрзЛржЧрзНржп systems project**ред