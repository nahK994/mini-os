# ржЕржзрзНржпрж╛рзЯ рзи

# ржкрзНрж░ржержо ржкржжржХрзНрж╖рзЗржк (First Steps)

ржПржХржЯрж┐ ржЕржкрж╛рж░рзЗржЯрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржо (OS) рждрзИрж░рж┐ ржХрж░рж╛ рж╕рж╣ржЬ ржХрж╛ржЬ ржирзЯред
тАЬржЖржорж┐ ржЖрж╕рж▓рзЗ рж╢рзБрж░рзБ ржХрж░ржмрзЛ ржХрзАржнрж╛ржмрзЗ?тАЭ тАФ ржПржЗ ржкрзНрж░рж╢рзНржиржЯрж┐ ржкрзБрж░рзЛ ржкрзНрж░ржЬрзЗржХрзНржЯ ржЪрж▓рж╛ржХрж╛рж▓рзАржи ржмрж╛рж░ржмрж╛рж░ ржорж╛ржерж╛рзЯ ржЖрж╕ржмрзЗред

ржПржЗ ржЕржзрзНржпрж╛рзЯрзЗ ржЖржорж░рж╛ рж╢рж┐ржЦржмрзЛ:

* ржбрзЗржнрзЗрж▓ржкржорзЗржирзНржЯ ржкрж░рж┐ржмрзЗрж╢ рж╕рзЗржЯржЖржк ржХрж░рж╛
* ржПржХржЯрж┐ ржХрзНрж╖рзБржжрзНрж░ ржУ ржкрзНрж░рж╛ржержорж┐ржХ ржЕржкрж╛рж░рзЗржЯрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржо ржмрзБржЯ ржХрж░рж╛ржирзЛ

---

# Tools

## Quick Setup

ржЖржорж░рж╛ (рж▓рзЗржЦржХрж░рж╛) OS ржбрзЗржнрзЗрж▓ржкржорзЗржирзНржЯрзЗрж░ ржЬржирзНржп Ubuntu ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐ред
ржПржЯрж┐ ржЖржорж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐:

* рж╕рж░рж╛рж╕рж░рж┐ (physical machine)
* ржПржмржВ VirtualBox ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ virtual machine рж╣рж┐рж╕рзЗржмрзЗ

Ubuntu ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛рж░ ржкрж░ ржирж┐ржЪрзЗрж░ ржкрзНржпрж╛ржХрзЗржЬржЧрзБрж▓рзЛ ржЗржирж╕рзНржЯрж▓ ржХрж░рждрзЗ рж╣ржмрзЗ:

```bash
sudo apt-get install build-essential nasm genisoimage bochs bochs-sdl
```

---

# Programming Languages

ржПржЗ ржмржЗрждрзЗ ржЕржкрж╛рж░рзЗржЯрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржо рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржмрзЗ **C programming language** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, GCC ржХржорзНржкрж╛ржЗрж▓рж╛рж░ ржжрж┐рзЯрзЗред

ржЖржорж░рж╛ C ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐ ржХрж╛рж░ржг:

* ржЬрзЗржирж╛рж░рзЗржЯ рж╣ржУрзЯрж╛ ржорзЗрж╢рж┐ржи ржХрзЛржбрзЗрж░ ржЙржкрж░ рж╕рзВржХрзНрж╖рзНржо ржирж┐рзЯржирзНрждрзНрж░ржг ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ
* рж╕рж░рж╛рж╕рж░рж┐ ржорзЗржорж░рж┐ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рж╛ ржпрж╛рзЯ

ржПржЗ ржмржЗрждрзЗ ржПржХржЯрж┐ GCC ржирж┐рж░рзНржжрж┐рж╖рзНржЯ attribute ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржмрзЗ:

```c
__attribute__((packed))
```

ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ struct ржПрж░ ржорзЗржорж░рж┐ рж▓рзЗржЖржЙржЯ ржарж┐ржХ ржпрзЗржнрж╛ржмрзЗ ржЖржорж░рж╛ рж▓рж┐ржЦрзЗржЫрж┐, рж╕рзЗржнрж╛ржмрзЗржЗ ржерж╛ржХржмрзЗред

тЪая╕П ржПржЗ attribute ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржХрж╛рж░ржгрзЗ GCC ржЫрж╛рзЬрж╛ ржЕржирзНржп ржХржорзНржкрж╛ржЗрж▓рж╛рж░рзЗ ржХрзЛржб ржХржорзНржкрж╛ржЗрж▓ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рждрзЗ ржкрж╛рж░рзЗред

Assembly рж▓рзЗржЦрж╛рж░ ржЬржирзНржп ржЖржорж░рж╛ NASM ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЛред

Scripting ржПрж░ ржЬржирзНржп Bash ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржмрзЗред

---

# Host Operating System

рж╕ржм ржХрзЛржб ржЙржжрж╛рж╣рж░ржг ржзрж░рзЗ ржирзЗрзЯ ржпрзЗ рждрзБржорж┐ UNIX-like OS ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЛред

Ubuntu 11.04 ржПржмржВ 11.10 ржП рж╕ржлрж▓ржнрж╛ржмрзЗ ржХржорзНржкрж╛ржЗрж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред

---

# Build System

Make ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ Makefile ржЙржжрж╛рж╣рж░ржг рждрзИрж░рж┐рж░ ржЬржирзНржпред

---

# Virtual Machine

OS ржбрзЗржнрзЗрж▓ржкржорзЗржирзНржЯрзЗ virtual machine ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржЕрждрзНржпржирзНржд рж╕рзБржмрж┐ржзрж╛ржЬржиржХред

ржХрж╛рж░ржг:

* physical hardware ржП ржмрж╛рж░ржмрж╛рж░ ржмрзБржЯ ржХрж░рж╛рж░ ржЭрж╛ржорзЗрж▓рж╛ ржирзЗржЗ
* ржжрзНрж░рзБржд ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛ ржпрж╛рзЯ
* debugging рж╕рж╣ржЬ

ржПржЗ ржмржЗрждрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ **Bochs**, ржпрж╛ x86 (IA-32) emulatorред

ржЕржирзНржпрж╛ржирзНржп ржЬржиржкрзНрж░рж┐рзЯ ржмрж┐ржХрж▓рзНржк:

* QEMU
* VirtualBox

---

# Booting

Booting ржорж╛ржирзЗ ржПржХрж╛ржзрж┐ржХ ржЫрзЛржЯ ржкрзНрж░рзЛржЧрзНрж░рж╛ржорзЗрж░ ржорж╛ржзрзНржпржорзЗ ржХржирзНржЯрзНрж░рзЛрж▓ рж╣рж╕рзНрждрж╛ржирзНрждрж░ рж╣ржУрзЯрж╛ред

ржкрзНрж░рждрж┐ржЯрж┐ ржзрж╛ржк ржЖржЧрзЗрж░ржЯрж┐рж░ ржЪрзЗрзЯрзЗ тАЬржЖрж░ржУ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзАтАЭред

```
[ BIOS ] тЖТ [ Bootloader ] тЖТ [ Operating System ]
```

ржкрзНрж░рждрж┐ржЯрж┐ ржмржХрзНрж╕ ржПржХржЯрж┐ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржирж┐рж░рзНржжрзЗрж╢ ржХрж░рзЗред

---

# BIOS

ржХржорзНржкрж┐ржЙржЯрж╛рж░ ржЪрж╛рж▓рзБ рж╣рж▓рзЗ ржкрзНрж░ржержорзЗ BIOS ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржЪрж╛рж▓рзБ рж╣рзЯред

BIOS:

* motherboard ржПрж░ ROM ржЪрж┐ржкрзЗ ржерж╛ржХрзЗ
* Power-On Self Test (POST) ржЪрж╛рж▓рж╛рзЯ
* рждрж╛рж░ржкрж░ bootloader ржП ржХржирзНржЯрзНрж░рзЛрж▓ ржжрзЗрзЯ

ржЖржзрзБржирж┐ржХ OS рж╕рж░рж╛рж╕рж░рж┐ BIOS ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирж╛ред
рждрж╛рж░рж╛ рж╕рж░рж╛рж╕рж░рж┐ hardware driver ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред

---

# The Bootloader

BIOS ржХржирзНржЯрзНрж░рзЛрж▓ ржжрзЗрзЯ Bootloader ржХрзЗред

Bootloader ржПрж░ ржХрж╛ржЬ:

* OS ржХрзЗ ржорзЗржорж░рж┐рждрзЗ рж▓рзЛржб ржХрж░рж╛
* рждрж╛рж░ржкрж░ OS ржХрзЗ ржХржирзНржЯрзНрж░рзЛрж▓ ржжрзЗржУрзЯрж╛

Bootloader рж╕рж╛ржзрж╛рж░ржгржд ржжрзБржЗ ржнрж╛ржЧрзЗ ржмрж┐ржнржХрзНржд:

ржХрж╛рж░ржг:

* MBR ржорж╛рждрзНрж░ рзлрззрзи ржмрж╛ржЗржЯ
* backward compatibility

ржЖржорж░рж╛ ржирж┐ржЬрзЗ bootloader рж▓рж┐ржЦржмрзЛ ржирж╛ред
ржЖржорж░рж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЛ **GNU GRUB**ред

GRUB:

* ELF executable рж▓рзЛржб ржХрж░рждрзЗ ржкрж╛рж░рзЗ
* Multiboot specification ржЕржирзБрж╕рж░ржг ржХрж░рзЗ

---

# The Operating System

GRUB ржПржХржЯрж┐ magic number ржЦрзБржБржЬрзЗ ржжрзЗржЦрзЗред

ржПржЗ magic number рж╣рж▓рзЛ multiboot specification ржПрж░ ржЕржВрж╢ред

рждрж╛рж░ржкрж░ GRUB jump ржХрж░рзЗ OS ржПрж░ entry point ржПред

рж╕рзЗржЗ ржорзБрж╣рзВрж░рзНржд ржерзЗржХрзЗ OS ржкрзБрж░рзЛ ржХржорзНржкрж┐ржЙржЯрж╛рж░рзЗрж░ ржХржирзНржЯрзНрж░рзЛрж▓ ржирзЗрзЯред

---

# Hello Cafebabe

ржПржЦржи ржЖржорж░рж╛ рж╕ржмржЪрзЗрзЯрзЗ ржЫрзЛржЯ рж╕ржорзНржнржм OS ржмрж╛ржирж╛ржмрзЛред

ржПржЯрж┐ рж╢рзБржзрзБ ржХрж░ржмрзЗ:

```
EAX = 0xCAFEBABE
```

---

# Compiling the Operating System

C ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛, ржХрж╛рж░ржг ржПржЦржирзЛ stack ржирзЗржЗред

ржлрж╛ржЗрж▓: `loader.s`

```asm
global loader

MAGIC_NUMBER equ 0x1BADB002
FLAGS equ 0x0
CHECKSUM equ -MAGIC_NUMBER

section .text
align 4

dd MAGIC_NUMBER
dd FLAGS
dd CHECKSUM

loader:
mov eax, 0xCAFEBABE

.loop:
jmp .loop
```

ржХржорзНржкрж╛ржЗрж▓:

```bash
nasm -f elf32 loader.s
```

---

# Linking the Kernel

ржЖржорж░рж╛ ржЪрж╛ржЗ kernel рж▓рзЛржб рж╣рзЛржХ тЙе 0x00100000 (1MB) ржарж┐ржХрж╛ржирж╛рзЯред

ржХрж╛рж░ржг:

* 1MB ржПрж░ ржирж┐ржЪрзЗ BIOS, GRUB, I/O ржмрзНржпржмрж╣рзГржд рж╣рзЯ

ржлрж╛ржЗрж▓: `link.ld`

```ld
ENTRY(loader)

SECTIONS {
. = 0x00100000;

.text ALIGN(0x1000) : {
*(.text)
}

.rodata ALIGN(0x1000) : {
*(.rodata*)
}

.data ALIGN(0x1000) : {
*(.data)
}

.bss ALIGN(0x1000) : {
*(COMMON)
*(.bss)
}
}
```

рж▓рж┐ржВржХ:

```bash
ld -T link.ld -melf_i386 loader.o -o kernel.elf
```

---

# Obtaining GRUB

ржЖржорж░рж╛ GRUB Legacy ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЛред

ржлрж╛ржЗрж▓: `stage2_eltorito`

ржПржЯрж┐ ржПржХржЗ ржлрзЛрж▓рзНржбрж╛рж░рзЗ рж░рж╛ржЦрждрзЗ рж╣ржмрзЗ ржпрзЗржЦрж╛ржирзЗ `loader.s` ржПржмржВ `link.ld` ржЖржЫрзЗред

---

# Building an ISO Image

ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐:

```bash
mkdir -p iso/boot/grub
cp stage2_eltorito iso/boot/grub/
cp kernel.elf iso/boot/
```

GRUB config: `menu.lst`

```
default=0
timeout=0

title os
kernel /boot/kernel.elf
```

ржлрзЛрж▓рзНржбрж╛рж░ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░:

```
iso
тФФтФАтФА boot
    тФЬтФАтФА grub
    тФВ   тФЬтФАтФА menu.lst
    тФВ   тФФтФАтФА stage2_eltorito
    тФФтФАтФА kernel.elf
```

ISO рждрзИрж░рж┐:

```bash
genisoimage -R \
-b boot/grub/stage2_eltorito \
-no-emul-boot \
-boot-load-size 4 \
-A os \
-input-charset utf8 \
-quiet \
-boot-info-table \
-o os.iso \
iso
```

---

# Running Bochs

ржлрж╛ржЗрж▓: `bochsrc.txt`

```
megs: 32
display_library: sdl
romimage: file=/usr/share/bochs/BIOS-bochs-latest
vgaromimage: file=/usr/share/bochs/VGABIOS-lgpl-latest
ata0-master: type=cdrom, path=os.iso, status=inserted
boot: cdrom
log: bochslog.txt
clock: sync=realtime, time0=local
cpu: count=1, ips=1000000
```

рж░рж╛ржи:

```bash
bochs -f bochsrc.txt -q
```

рждрж╛рж░ржкрж░ рж▓ржЧ ржжрзЗржЦрзЛ:

```bash
cat bochslog.txt
```

ржпржжрж┐ ржжрзЗржЦрзЛ:

```
EAX=CAFEBABE
```

рждрж╛рж╣рж▓рзЗ рждрзЛржорж╛рж░ OS рж╕ржлрж▓ржнрж╛ржмрзЗ ржмрзБржЯ рж╣рзЯрзЗржЫрзЗ ЁЯОЙ

---

# Further Reading

тАв [http://duartes.org/gustavo/blog/post/how-computers-boot-up](http://duartes.org/gustavo/blog/post/how-computers-boot-up)
тАв [http://duartes.org/gustavo/blog/post/kernel-boot-process](http://duartes.org/gustavo/blog/post/kernel-boot-process)
тАв [http://wiki.osdev.org/Boot_Sequence](http://wiki.osdev.org/Boot_Sequence)
